# 项目 Docker 化设计

日期：2026-02-05

## 目标

- 将前后端以 Docker 方式部署。
- 通过 Nginx 统一入口提供前端静态资源与后端 API。
- SQLite 数据持久化到宿主机。
- 容器启动时自动执行初始化数据（seed）。

## 架构与组件

采用 Docker Compose 两个服务：

- `backend`：FastAPI（uvicorn）服务。
- `web`：Nginx，提供前端静态站点并反向代理 `/api` 到后端。

这样前端只访问同源地址，避免跨域问题。后端使用 SQLite，并将数据库文件挂载到宿主机目录，保证容器重启后数据保留。后端容器启动时先执行 `seed.py`，再启动 uvicorn 服务。

新增/调整文件：

- `backend/Dockerfile`
- `backend/start.sh`
- `frontend/Dockerfile`
- `frontend/nginx.conf`
- `docker-compose.yml`
- 修改 `frontend/app.js` 的 API 基地址为 `/api`

## 数据流

- 浏览器访问 Nginx 的 80 端口，静态资源直接由 Nginx 提供。
- 前端调用 `/api/*`，Nginx 反代到 `backend:8000`。
- 后端读取/写入 SQLite 数据库（路径由 `DATABASE_URL` 指定）。

## 启动与初始化

- `backend` 启动脚本执行 `seed.py`（幂等，不重复插入已有数据）。
- 随后启动 uvicorn 提供 API。
- `web` 依赖后端可用；后端暂不可用时静态页面仍可访问。

## 实现过程

1. 为后端编写 Dockerfile：使用 `python:3.11-slim`，安装依赖，复制后端代码与前端数据文件。
2. 添加后端启动脚本 `start.sh`：先执行 `python -m app.seed`，再启动 uvicorn。
3. 为前端编写 Dockerfile：基于 `nginx:1.27-alpine`，复制静态文件与 Nginx 配置。
4. 编写 `nginx.conf`：静态资源由 Nginx 提供，`/api` 反代到 `backend:8000`。
5. 创建 `docker-compose.yml`：编排 `backend` 与 `web`，映射 80 端口，挂载 SQLite 数据目录。
6. 修改前端 `app.js`：将 API 基地址改为 `/api`，实现同源访问。

## 错误处理

- Nginx 代理失败时返回 502/504。
- 前端已有 `fetchJson` 错误捕获逻辑，无需额外调整。
- 后端路由与响应结构保持不变。

## 验证与测试

建议本地验证步骤：

1. `docker compose up --build`
2. 访问 `/` 页面是否正常加载。
3. 访问 `/api/health` 返回 `{"status":"ok"}`。
4. 前端功能（资源加载、待办等）是否正常。

如需更强保障，可在 Compose 中增加健康检查（如 curl `/health`）。
